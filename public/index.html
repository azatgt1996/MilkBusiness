<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Milk business</title>
    <script src="vendor/vue.global.prod.js"></script>
    <link rel="stylesheet" href="vendor/pure-min.css" />
    <script src="vendor/notyf.min.js"></script>
    <link rel="stylesheet" href="vendor/notyf.min.css" />
    <script src="vendor/nanoid.js"></script>
    <script src="utils.js" defer></script>
    <script src="app.js" defer></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="app">
      <transition name="fade" mode="out-in">
        <div :class="{loading}" :key="currentPage">
          <div class="loader"></div>
          <div v-if="currentPage === 'auth'" class="auth-container">
            <h3>Авторизация</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="enter">
              <fieldset>
                <div class="pure-control-group">
                  <label for="login">Логин</label>
                  <input v-model="auth.login" type="text" id="login" placeholder="Введите логин" required />
                </div>
                <div class="pure-control-group">
                  <label for="password">Пароль</label>
                  <input v-model="auth.password" type="password" id="password" placeholder="Введите пароль" required />
                </div>
                <a @click.prevent="showTel" href="">Забыли пароль?</a>
                <div class="pure-controls">
                  <button type="submit" class="pure-button pure-button-primary">Войти</button>
                </div>
              </fieldset>
            </form>
          </div>

          <div v-else-if="currentPage === 'sales'">
            <h3>Список продаж ({{ currentUser }})</h3>
            <table id="sales-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <th v-for="label in ['Дата', 'Кол-во', 'Цена', 'Стоимость']">{{ label }}</th>
              </thead>
              <tbody>
                <tr v-for="it in sales">
                  <td>{{ formatDate(it.date) }}</td>
                  <td class="volume-td">
                    <div>{{ it.volume }} л</div>
                    <div>{{ it.proteins || it.fats ? `(${it.proteins || '-'} / ${it.fats || '-'})` : '' }}</div>
                  </td>
                  <td>{{ it.price }} ₽</td>
                  <td>{{ it.volume * it.price }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="exit">Выйти</button>
              <button class="pure-button" @click="gotoReport">Отчет</button>
            </div>
          </div>
          <div v-else-if="currentPage === 'deals'">
            <h3 class="pure-form form-header">
              <span>Список сделок</span>
              <input v-model="dateFilter" type="date" :max="today" />
            </h3>
            <table id="deals-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <th v-for="label in ['ФИО', 'Дата', 'Кол-во', 'Цена', 'Стоимость']">{{ label }}</th>
              </thead>
              <tbody>
                <tr v-for="(it, index) in filteredDeals" :key="index" @click="openDeal(it.id)">
                  <td>{{ it.fio }}</td>
                  <td>{{ formatDate(it.date) }}</td>
                  <td class="volume-td">
                    <div>{{ it.volume }} л</div>
                    <div>{{ it.proteins || it.fats ? `(${it.proteins || '-'} / ${it.fats || '-'})` : '' }}</div>
                  </td>
                  <td>{{ it.price }} ₽</td>
                  <td>{{ it.volume * it.price }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="exit">Выйти</button>
              <button class="pure-button" @click="currentPage = 'clients'">Список клиентов</button>
              <button class="pure-button" @click="gotoReport">Отчет</button>
              <button class="pure-button pure-button-primary" @click="openDeal()">Добавить сделку</button>
            </div>
          </div>
          <div v-else-if="currentPage === 'dealCard'">
            <h3>{{ deal.id ? 'Изменение' : 'Добавление' }} сделки</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="saveDeal">
              <fieldset>
                <div class="pure-control-group">
                  <label for="fio">ФИО</label>
                  <select v-model="deal.fio" id="fio" required>
                    <option value="" disabled selected>Выберите клиента</option>
                    <option v-for="(it, idx) in sortedClients" :key="idx" :value="it.fio">{{ it.fio }}</option>
                  </select>
                </div>
                <div class="pure-control-group">
                  <label for="date">Дата</label>
                  <input v-model="deal.date" type="date" id="date" :max="today" required />
                </div>
                <div class="pure-control-group">
                  <label for="volume">Кол-во литров</label>
                  <input v-model="deal.volume" type="number" id="volume" min="0" required />
                </div>
                <div class="pure-control-group">
                  <label for="price">Цена, ₽</label>
                  <input v-model="deal.price" type="number" id="price" min="0" required />
                </div>
                <div class="inline-controls">
                  <div class="pure-control-group">
                    <label for="proteins">Белки</label>
                    <input
                      v-model="deal.proteins"
                      type="number"
                      id="proteins"
                      min="0"
                      step="0.1"
                      style="width: 100px"
                    />
                  </div>
                  <div class="pure-control-group">
                    <label for="fats">Жиры</label>
                    <input v-model="deal.fats" type="number" id="fats" min="0" step="0.1" style="width: 100px" />
                  </div>
                </div>
                <div class="pure-controls">
                  <button type="button" class="pure-button" @click="currentPage = 'deals'">Назад</button>
                  <button type="submit" class="pure-button pure-button-primary">Сохранить</button>
                </div>
              </fieldset>
            </form>
          </div>

          <div v-else-if="currentPage === 'report'">
            <h3 class="pure-form form-header">
              <span>Отчет</span>
              <select v-if="currentUser === 'admin'" v-model="period">
                <option value="all">Все периоды</option>
                <option v-for="(it, index) in periods" :key="index" :value="it.value">{{ it.label }}</option>
              </select>
            </h3>
            <table
              v-if="period === 'all'"
              id="report-table-1"
              class="pure-table pure-table-horizontal pure-table-striped"
            >
              <thead>
                <tr>
                  <th v-for="label in ['Период', 'Кол-во', 'Итого']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in reportData">
                  <td>{{ it.period }}</td>
                  <td>{{ it.volume }} л</td>
                  <td>{{ it.sum }} ₽</td>
                </tr>
              </tbody>
            </table>
            <table v-else id="report-table-2" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <tr>
                  <th v-for="label in ['ФИО', 'Кол-во', 'Итого']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in reportData">
                  <td>{{ it.fio }}</td>
                  <td>{{ it.volume }} л</td>
                  <td>{{ it.sum }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="backFromReport">Назад</button>
            </div>
          </div>

          <div v-else-if="currentPage === 'clients'">
            <h3>Список клиентов</h3>
            <table id="clients-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <tr>
                  <th v-for="label in ['Логин', 'ФИО', 'Адрес', 'Телефон']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in sortedClients" :key="it.login" @click="openClient(it.id)">
                  <td>{{ it.login }}</td>
                  <td>{{ it.fio }}</td>
                  <td>{{ it.address }}</td>
                  <td>{{ it.phone }}</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="currentPage = 'deals'">Назад</button>
              <button class="pure-button pure-button-primary" @click="openClient()">Добавить клиента</button>
            </div>
          </div>
          <div v-else-if="currentPage === 'clientCard'">
            <h3>{{ client.id ? 'Изменение' : 'Добавление' }} клиента</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="saveClient">
              <fieldset>
                <div class="pure-control-group">
                  <label for="fio">ФИО</label>
                  <input
                    v-model="client.fio"
                    type="text"
                    id="fio"
                    placeholder="Введите ФИО"
                    required
                    :readonly="client.id"
                  />
                </div>
                <div class="pure-control-group">
                  <label for="login">Логин</label>
                  <input
                    v-model="client.login"
                    type="text"
                    id="login"
                    pattern="[a-zA-Z]{4,8}"
                    placeholder="Введите логин"
                    :readonly="client.id"
                    required
                  />
                  <small>4-8 символов латиница</small>
                </div>
                <div class="pure-control-group">
                  <label for="password">Пароль</label>
                  <input
                    v-model="client.password"
                    type="text"
                    id="password"
                    pattern="[a-z0-9]{6,12}"
                    placeholder="Введите пароль"
                    :required="!client.id"
                  />
                  <small>6-12 символов латиница\цифры</small>
                </div>
                <div class="pure-control-group">
                  <label for="address">Адрес</label>
                  <input v-model="client.address" type="text" id="address" placeholder="Введите адрес" />
                </div>
                <div class="pure-control-group">
                  <label for="phone">Телефон</label>
                  <input v-model="client.phone" type="tel" id="phone" pattern="[0-9]{11}" placeholder="89001112233" />
                </div>
                <div class="pure-control-group">
                  <label for="comment">Примечание</label>
                  <textarea
                    v-model="client.comment"
                    id="comment"
                    placeholder="Введите примечание"
                    style="width: 200px"
                  ></textarea>
                </div>
                <div class="pure-controls">
                  <button type="button" class="pure-button" @click="currentPage = 'clients'">Назад</button>
                  <button type="submit" class="pure-button pure-button-primary">Сохранить</button>
                </div>
              </fieldset>
            </form>
          </div>
        </div>
      </transition>
    </div>
  </body>
</html>
