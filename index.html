<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Milk business</title>
    <script src="vue.global.prod.js"></script>
    <link rel="stylesheet" href="pure-min.css" />
    <script src="notyf.min.js"></script>
    <link rel="stylesheet" href="notyf.min.css" />

    <!-- <script src="https://unpkg.com/vue@3.5.26/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.5/build/pure-min.css" />
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css" /> -->
    <style>
      #app {
        margin: 10px auto;
        width: 94%;
      }
      .fade-enter-active,
      .fade-leave-active {
        transition: opacity 0.2s;
      }
      .fade-enter-from,
      .fade-leave-to {
        opacity: 0;
      }

      .auth-container {
        margin: auto;
        width: fit-content;
      }
      .milk-attributes-box {
        display: flex;
        gap: 10px;

        input {
          width: 100px;
        }
      }
      .volume-td {
        text-align: center;
        div:nth-child(2) {
          font-size: 12px;
          color: gray;
        }
      }
      .period-box {
        display: flex;
        gap: 16px;
      }

      .form-header {
        display: flex;
        align-items: center;
        justify-content: space-between;

        input,
        select {
          height: 28px;
          margin: 0 !important;
          padding: 0 0.6em;
        }
      }
      h3 {
        line-height: 28px;
        padding-inline: 5px;
      }

      .buttons-panel,
      .pure-controls {
        margin-top: 16px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .pure-table {
        border-radius: 5px;
        display: block;
        overflow-x: auto;

        thead,
        tbody {
          display: block;
          width: max-content;
        }

        tbody {
          overflow-y: auto;
          height: calc(100vh - 300px);
        }
      }
      .pure-form select {
        appearance: none;
        width: 240px;
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjMDAwMDAwIj48cGF0aCBkPSJNMTIgMTUuNWw0LjUtNC41aC05eiIvPjwvc3ZnPg==);
        background-position: 100%;
        background-repeat: no-repeat;
      }
      .pure-button {
        border-radius: 5px;
        margin: 0 !important;
      }
      .pure-control-group {
        margin-bottom: 16px;

        small {
          display: block;
          color: gray;
          margin-top: -4px;
          margin-left: 4px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <transition name="fade" mode="out-in">
        <div :key="currentPage">
          <div v-if="currentPage === 'auth'" class="auth-container">
            <h3>Авторизация</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="enter">
              <fieldset>
                <div class="pure-control-group">
                  <label for="login">Логин</label>
                  <input v-model="auth.login" type="text" id="login" placeholder="Введите логин" required />
                </div>
                <div class="pure-control-group">
                  <label for="password">Пароль</label>
                  <input v-model="auth.password" type="password" id="password" placeholder="Введите пароль" required />
                </div>
                <div class="pure-controls">
                  <button type="submit" class="pure-button pure-button-primary">Войти</button>
                </div>
              </fieldset>
            </form>
          </div>

          <div v-else-if="currentPage === 'sales'">
            <h3>Список продаж ({{ currentUser }})</h3>
            <table id="sales-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <th v-for="label in ['Дата', 'Кол-во', 'Цена', 'Стоимость']">{{ label }}</th>
              </thead>
              <tbody>
                <tr v-for="it in sales">
                  <td>{{ new Date(it.date).toLocaleDateString() }}</td>
                  <td class="volume-td">
                    <div>{{ it.volume }} л</div>
                    <div>{{ it.proteins || it.fats ? `(${it.proteins || '-'} / ${it.fats || '-'})` : '' }}</div>
                  </td>
                  <td>{{ it.price }} ₽</td>
                  <td>{{ it.volume * it.price }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="exit">Выйти</button>
              <button class="pure-button" @click="gotoReport">Отчет</button>
            </div>
          </div>

          <div v-else-if="currentPage === 'deals'">
            <h3 class="pure-form form-header">
              <span>Список сделок</span>
              <input v-model="dateFilter" type="date" :max="new Date().toISOString().slice(0, 10)" />
            </h3>
            <table id="deals-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <th v-for="label in ['ФИО', 'Дата', 'Кол-во', 'Цена', 'Стоимость']">{{ label }}</th>
              </thead>
              <tbody>
                <tr v-for="(it, index) in filteredDeals" @click="openDeal(index)">
                  <td>{{ it.fio }}</td>
                  <td>{{ new Date(it.date).toLocaleDateString() }}</td>
                  <td class="volume-td">
                    <div>{{ it.volume }} л</div>
                    <div>{{ it.proteins || it.fats ? `(${it.proteins || '-'} / ${it.fats || '-'})` : '' }}</div>
                  </td>
                  <td>{{ it.price }} ₽</td>
                  <td>{{ it.volume * it.price }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="exit">Выйти</button>
              <button class="pure-button" @click="currentPage = 'clients'">Список клиентов</button>
              <button class="pure-button" @click="gotoReport">Отчет</button>
              <button class="pure-button pure-button-primary" @click="openDeal()">Добавить сделку</button>
            </div>
          </div>

          <div v-else-if="currentPage === 'dealCard'">
            <h3>{{ dealIndex === null ? 'Добавление сделки' : 'Изменение сделки' }}</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="saveDeal">
              <fieldset>
                <div class="pure-control-group">
                  <label for="fio">ФИО</label>
                  <select v-model="deal.fio" id="fio" required>
                    <option value="" disabled selected>Выберите клиента</option>
                    <option v-for="it in store.clients" :key="it.login" :value="it.fio">{{ it.fio }}</option>
                  </select>
                </div>
                <div class="pure-control-group">
                  <label for="date">Дата</label>
                  <input
                    v-model="deal.date"
                    type="date"
                    id="date"
                    :max="new Date().toISOString().slice(0, 10)"
                    required
                  />
                </div>
                <div class="pure-control-group">
                  <label for="volume">Кол-во литров</label>
                  <input v-model="deal.volume" type="number" id="volume" min="0" required />
                </div>
                <div class="pure-control-group">
                  <label for="price">Цена, ₽</label>
                  <input v-model="deal.price" type="number" id="price" min="0" required />
                </div>
                <div class="milk-attributes-box">
                  <div class="pure-control-group">
                    <label for="proteins">Белки</label>
                    <input v-model="deal.proteins" type="number" id="proteins" min="0" step="0.1" />
                  </div>
                  <div class="pure-control-group">
                    <label for="fats">Жиры</label>
                    <input v-model="deal.fats" type="number" id="fats" min="0" step="0.1" />
                  </div>
                </div>
                <div class="pure-controls">
                  <button type="button" class="pure-button" @click="currentPage = 'deals'">Назад</button>
                  <button type="submit" class="pure-button pure-button-primary">Сохранить</button>
                </div>
              </fieldset>
            </form>
          </div>

          <div v-else-if="currentPage === 'report'">
            <h3 class="pure-form form-header">
              <span>Отчет</span>
              <select v-if="currentUser === 'admin'" v-model="period">
                <option value="all">Все периоды</option>
                <option v-for="(it, index) in periods" :key="index" :value="it">{{ it }}</option>
              </select>
            </h3>
            <table
              v-if="period === 'all'"
              id="report-table-1"
              class="pure-table pure-table-horizontal pure-table-striped"
            >
              <thead>
                <tr>
                  <th v-for="label in ['Период', 'Кол-во', 'Итого']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in reportData">
                  <td>{{ it.period }}</td>
                  <td>{{ it.volume }}</td>
                  <td>{{ it.sum }} ₽</td>
                </tr>
              </tbody>
            </table>
            <table v-else id="report-table-2" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <tr>
                  <th v-for="label in ['ФИО', 'Кол-во', 'Итого']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in reportData">
                  <td>{{ it.fio }}</td>
                  <td>{{ it.volume }}</td>
                  <td>{{ it.sum }} ₽</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="backFromReport">Назад</button>
            </div>
          </div>

          <div v-else-if="currentPage === 'clients'">
            <h3>Список клиентов</h3>
            <table id="clients-table" class="pure-table pure-table-horizontal pure-table-striped">
              <thead>
                <tr>
                  <th v-for="label in ['Логин', 'ФИО', 'Адрес', 'Телефон']">{{ label }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="it in store.clients">
                  <td>{{ it.login }}</td>
                  <td>{{ it.fio }}</td>
                  <td>{{ it.address }}</td>
                  <td>{{ it.phone }}</td>
                </tr>
              </tbody>
            </table>
            <div class="buttons-panel">
              <button class="pure-button" @click="currentPage = 'deals'">Назад</button>
              <button class="pure-button pure-button-primary" @click="currentPage = 'newClient'">
                Добавить клиента
              </button>
            </div>
          </div>

          <div v-else-if="currentPage === 'newClient'">
            <h3>Добавление клиента</h3>
            <form class="pure-form pure-form-stacked" @submit.prevent="saveClient">
              <fieldset>
                <div class="pure-control-group">
                  <label for="login">Логин</label>
                  <input
                    v-model="client.login"
                    type="text"
                    id="login"
                    pattern="[a-zA-Z]{4,8}"
                    placeholder="Введите логин"
                    required
                  />
                  <small>4-8 символов латиница</small>
                </div>
                <div class="pure-control-group">
                  <label for="password">Пароль</label>
                  <input
                    v-model="client.password"
                    type="password"
                    id="password"
                    pattern="[a-z0-9]{6,12}"
                    placeholder="Введите пароль"
                    required
                  />
                  <small>6-12 символов латиница\цифры</small>
                </div>
                <div class="pure-control-group">
                  <label for="fio">ФИО</label>
                  <input v-model="client.fio" type="text" id="fio" placeholder="Введите ФИО" required />
                </div>
                <div class="pure-control-group">
                  <label for="address">Адрес</label>
                  <input v-model="client.address" type="text" id="address" placeholder="Введите адрес" />
                </div>
                <div class="pure-control-group">
                  <label for="phone">Телефон</label>
                  <input v-model="client.phone" type="tel" id="phone" pattern="[0-9]{11}" placeholder="89001112233" />
                </div>
                <div class="pure-controls">
                  <button type="button" class="pure-button" @click="currentPage = 'clients'">Назад</button>
                  <button type="submit" class="pure-button pure-button-primary">Сохранить</button>
                </div>
              </fieldset>
            </form>
          </div>
        </div>
      </transition>
    </div>

    <script>
      const notyf = new Notyf({ position: { x: 'center', y: 'bottom' } })
      const { createApp, ref, watch, computed } = Vue

      function getTwoWeekPeriods(startDate, endDate) {
        const start = new Date(startDate)
        const end = new Date(endDate)
        const periods = []
        let currentStart = new Date(start.getFullYear(), start.getMonth(), start.getDate() > 15 ? 16 : 1)

        while (currentStart <= end) {
          const year = currentStart.getFullYear()
          const month = currentStart.getMonth()

          let periodEnd
          if (currentStart.getDate() === 1) {
            periodEnd = new Date(year, month, 15)
          } else {
            const nextMonth = new Date(year, month + 1, 0)
            periodEnd = new Date(year, month, nextMonth.getDate())
          }
          periods.push(`${new Date(currentStart).toLocaleDateString()} - ${new Date(periodEnd).toLocaleDateString()}`)
          currentStart = currentStart.getDate() === 1 ? new Date(year, month, 16) : new Date(year, month + 1, 1)
        }
        return periods
      }

      function getMinMaxDates(arr) {
        const dates = arr.map((it) => it.date)
        const min = dates.sort()[0]
        const max = dates.sort().reverse()[0]
        return { min, max }
      }

      function fastHash(data) {
        const str = JSON.stringify(data)
        const seed = 0x811c9dc5
        let hash = seed
        for (let i = 0; i < str.length; i++) {
          hash = Math.imul(hash ^ str.charCodeAt(i), 0x01000193)
          hash >>>= 0
        }
        return (hash >>> 0).toString(36)
      }

      const _token = 'Z2hwX2FsYVlYU2dRQ3F1MmVvan' + 'ZLWWlBblBhdlVsT2pPUjNqN3ZhRQ=='
      const service = {
        url: 'https://api.github.com/gists/a76d3bb997ac279cc6d96cc7de984d48',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `token ${atob(_token)}`,
        },
        file: 'milk_business.json',
        async getData() {
          const res = await fetch(this.url, { method: 'GET', headers: this.headers })
          const { files } = await res.json()
          return JSON.parse(files[this.file].content)
        },
        async saveData(content) {
          const body = { files: { [this.file]: { content: JSON.stringify(content) } } }
          await fetch(this.url, { method: 'PATCH', headers: this.headers, body: JSON.stringify(body) })
        },
      }

      const ls = {
        get: (key) => localStorage.getItem(key),
        set: (key, value) => localStorage.setItem(key, value),
      }

      const $clone = (obj) => JSON.parse(JSON.stringify(obj))

      function setWidth(table, widths) {
        const style = document.createElement('style')
        widths.forEach((width, i) => {
          const w = `${width}px`
          style.textContent += `${table} td:nth-child(${i + 1}), ${table} th:nth-child(${i + 1})
            { min-width: ${w}; max-width: ${w}; }`
        })
        document.head.appendChild(style)
      }

      setWidth('#clients-table', [70, 140, 150, 92])
      setWidth('#deals-table', [140, 90, 60, 40, 90])
      setWidth('#sales-table', [110, 100, 100, 100])
      setWidth('#report-table-1', [120, 60, 80])
      setWidth('#report-table-2', [140, 60, 80])

      createApp({
        setup() {
          const currentPage = ref(ls.get('currentPage') ?? 'auth')
          const currentUser = ref(ls.get('currentUser') ?? '')

          watch(currentPage, (val) => ls.set('currentPage', currentPage.value))

          const store = ref({ clients: [], deals: [] })
          const period = ref('all')

          const periods = computed(() => {
            const arr = currentUser.value === 'admin' ? store.value.deals : sales.value
            const { min, max } = getMinMaxDates(arr)
            return getTwoWeekPeriods(min, max)
          })

          const reportData = computed(() => {
            const arr = currentUser.value === 'admin' ? store.value.deals : sales.value

            if (period.value === 'all') {
              return periods.value.map((period) => {
                const [start, end] = period.split(' - ').map((it) => it.split('.').toReversed().join('-'))
                const rows = arr.filter((it) => it.date >= start && it.date <= end)
                const volume = rows.reduce((sum, it) => sum + it.volume, 0)
                const sum = rows.reduce((sum, it) => sum + it.volume * it.price, 0)
                return { period, volume, sum }
              })
            } else {
              const [start, end] = period.value.split(' - ').map((it) => it.split('.').toReversed().join('-'))
              const rows = arr.filter((it) => it.date >= start && it.date <= end)
              const result = []
              for (const row of rows) {
                const existing = result.find((it) => it.fio === row.fio)
                if (existing) {
                  existing.volume += row.volume
                  existing.sum += row.volume * row.price
                } else {
                  result.push({ fio: row.fio, volume: row.volume, sum: row.volume * row.price })
                }
              }
              return result
            }
          })

          function gotoReport() {
            currentPage.value = 'report'
            period.value = 'all'
          }

          function backFromReport() {
            currentPage.value = currentUser.value === 'admin' ? 'deals' : 'sales'
          }

          async function initStore() {
            store.value = await service.getData()
          }

          async function saveStore() {
            await service.saveData(store.value)
          }

          initStore()

          const auth = ref({ login: '', password: '' })

          async function enter() {
            const { login, password } = auth.value
            const passwordHash = await fastHash(password)
            if (login === 'admin') {
              if (passwordHash !== 'avcrry') {
                return notyf.error('Неверный пароль')
              }
              currentPage.value = 'deals'
            } else {
              const client = store.value.clients.find((it) => it.login === login)
              if (!client) return notyf.error('Пользователь не найден')
              if (client.passwordHash !== passwordHash) return notyf.error('Неверный пароль')
              currentPage.value = 'sales'
            }
            currentUser.value = login
            ls.set('currentUser', currentUser.value)
          }

          function exit() {
            currentPage.value = 'auth'
            ls.set('currentUser', currentUser.value)
            auth.value = { login: '', password: '' }
          }

          const sales = computed(() => {
            if (currentUser.value === 'admin') return []

            const client = store.value.clients.find((it) => it.login === currentUser.value)
            return store.value.deals.filter((it) => it.fio === client.fio)
          })

          const _client = { login: '', password: '', fio: '', address: '', phone: '' }
          const client = ref($clone(_client))

          async function saveClient() {
            const { login, password, fio, address, phone } = client.value
            if (store.value.clients.find((it) => it.login === login)) {
              return notyf.error('Клиент с таким логином уже есть')
            }
            if (store.value.clients.find((it) => it.fio === fio)) {
              return notyf.error('Клиент с таким ФИО уже есть')
            }
            const passwordHash = await fastHash(password)
            store.value.clients.push({ login, passwordHash, fio, address, phone })
            await saveStore()
            notyf.success('Клиент добавлен')
            client.value = $clone(_client)
            currentPage.value = 'clients'
          }

          const _deal = {
            fio: '',
            date: new Date().toISOString().slice(0, 10),
            volume: null,
            price: null,
            proteins: undefined,
            fats: undefined,
          }

          const deal = ref($clone(_deal))
          const dealIndex = ref(null)
          const dateFilter = ref(null)

          const filteredDeals = computed(() => {
            if (!dateFilter.value) return store.value.deals
            return store.value.deals.filter((it) => it.date === dateFilter.value)
          })

          function openDeal(index = null) {
            dealIndex.value = index
            deal.value = $clone(index !== null ? store.value.deals[index] : _deal)
            currentPage.value = 'dealCard'
          }

          async function saveDeal() {
            const { fio, date, volume, price, proteins, fats } = deal.value
            const data = {
              fio,
              date,
              volume,
              price,
              proteins: proteins || undefined,
              fats: fats || undefined,
            }
            if (dealIndex.value !== null) {
              store.value.deals[dealIndex.value] = data
            } else {
              store.value.deals.push(data)
            }
            await saveStore()
            notyf.success(dealIndex.value !== null ? 'Сделка изменена' : 'Сделка добавлена')
            currentPage.value = 'deals'
          }

          return {
            currentPage,
            currentUser,
            store,
            auth,
            enter,
            exit,
            sales,
            period,
            periods,
            reportData,
            gotoReport,
            backFromReport,
            client,
            saveClient,
            deal,
            dealIndex,
            dateFilter,
            filteredDeals,
            saveDeal,
            openDeal,
          }
        },
      }).mount('#app')
    </script>
  </body>
</html>
